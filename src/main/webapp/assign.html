<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>The HTML5 Herald</title>
    <meta name="description" content="The HTML5 Herald">
    <meta name="author" content="SitePoint">

    <style>
        .container {
            max-width: 900px;
            margin: 20px auto;
        }

        a,
        div,
        p {
            font-family: 'Microsoft Yahei', Arial, Helvetica, sans-serif;
        }

        a.nav {
            margin: 0 20px 0 0;
            border: 1px solid #a33;
            padding: 4px 6px;
            border-radius: 4px;
            text-decoration: none;
            background-color: #a33;
            color: white;
        }

        .item {
            justify-content: space-between;
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #d7d7d7;
        }

        .item .choose {
            width: 120px;
            padding: 3px 4px;
        }

        #iptSearch {
            width: 320px;
            box-sizing: border-box;
            padding: 5px 8px
        }

        #hintBox {
            position: absolute;
            padding: 5px 0px;
            border: 1px solid #999;
            width: 320px;
            box-sizing: border-box;
            background-color: #f5f6f7;
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            font-size: 14px;
        }

        .hintList {
            cursor: pointer;
            margin-bottom: 2px;
            padding: 3px 6px;
        }

        .hintList:hover {
            background-color: #d7d7d7;

        }

        #companyDsp {
            font-size: 14px;
        }

        #companyDsp span {
            font-size: 13px;
            color: grey;
            margin-left: 18px;
        }
    </style>

</head>

<body>

    <div class="container">
        <div style="margin-bottom: 30px;">
            <a href="index.jsp" class="nav">客户/联系人合并</a>
            <a href="listhistory.jsp" class="nav">客户/联系人合并记录</a>
        </div>

        <div>
            <div
                style="padding: 0 0 18px; margin-bottom: 6px;border-bottom: 1px solid #d7d7d7;display: flex; justify-content: flex-end;">
                <div style="margin-right: 18px;">搜索单位</div>
                <div>
                    <input class='searchBox' id='iptSearch' autocomplete="off">
                    <div id='hintBox' style="display: none;">
                        <div class="hintList">sd</div>
                    </div>
                </div>

            </div>

            <div id='companyListContent'>
                <div class="item">
                    <div class="companyInfo">
                        <div id='companyDsp'></div>
                    </div>
                    <form>
                        <select name="salesman" class="choose" id="chooseOne">
                        </select>
                        <button id='updateConfirm'>确定</button>
                    </form>

                </div>
            </div>

        </div>



    </div>



    <script>
        let hintPointer = 0;
        let hintNo = 0;
        let searchInput = "";
        let host = "http://localhost:8080";

        let iptSearch = document.getElementById('iptSearch');
        let hintBox = document.getElementById('hintBox');


        let salesmanList = ['', '王月红', '张亚青', '张宝洋', '陈志文', '黄敏', '程小刚', '张妙', '陈家云', '马伟',
            '唐昀成', '马芳婷', '程定尧', '梁俊', '龙鱼', '王宜桂', '周晨光', '徐俊', '测试员1'];



        iptSearch.addEventListener('focusout', function () {
            setTimeout(function () { hintBox.style.display = 'none'; }, 200);
        });
        iptSearch.addEventListener('focusin', function () {
            if (hintNo > 0) {
                hintBox.style.display = 'block';
            }
        });


        iptSearch.addEventListener('keydown', function (e) {
            let code = event.keyCode || event.which;
            let special = [37, 38, 39, 40];
            let str = iptSearch.value;
            // console.log(str);
            if (!(special.indexOf(code) > 0) && code === 13) {
                searchInput = str;
                showHint(str);
            }
        });



        iptSearch.addEventListener('keydown', function (e) {
            let code = e.keyCode || e.which;

            if ((code === 40 || code === 38) && hintNo > 0) {
                e.preventDefault();
                console.log('z')
                if (code == 40) {
                    if (hintPointer >= hintNo) {
                        hintPointer = 1;
                    } else {
                        hintPointer++;
                    }
                } else if (code == 38) {
                    if (hintPointer > 0) {
                        hintPointer--;
                    } else if (hintPointer == 0) {
                        hintPointer = hintNo;
                    }
                }

                /*
        
                if(hintPointer>0){
                  $(".hintList").find("a").css({"color":"#555","font-weight":"normal"});
                  $(".hintList").eq(hintPointer - 1).find("a").css({"color":"#A33","font-weight":"bold"});
                  var newValue = $(".hintList").eq(hintPointer - 1).find("a").html();
                  $("#iptSearch").val(newValue);
                }else{
                  $(".hintList").find("a").css({"color":"#555","font-weight":"normal"});
                  $("#iptSearch").val(searchInput);
                }
      
                */

            }
        });





        function showHint(str) {
            if (str.length <= 2) {
                hintNo = 0;
                hintBox.style.display = 'None';
            } else {
                hintBox.innerHTML = '';
                let url = host + "/comMerge/geCompanyList?key=" + str;
                
                fetch(url, {
                    mode: 'cors', // 'cors' by default
                    method: 'Get',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                    },
                    // body: JSON.stringify(data),
                }).then(function(response){
                    console.log(response);
                    return response.json();
                }).then(data => {
                        DisplayList(data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                    

                function DisplayList(ht) {
                    hintNo = ht.length;
                    if (ht.length > 0) {
                        let i;
                        for (i = 0; i < ht.length; i++) {
                            let div = document.createElement("div");
                            let t = document.createTextNode(ht[i].companyname);
                            div.setAttribute("class", "hintList");
                            div.setAttribute('comid', ht[i].comID);
                            if (ht[i].csalesman == null) {
                                div.setAttribute('salesman', '');
                            } else {
                                div.setAttribute('salesman', ht[i].csalesman);
                            }

                            div.appendChild(t);
                            div.addEventListener('click', getCompanybyID);
                            hintBox.appendChild(div);
                        }
                        hintBox.style.display = 'block';
                    }
                }


                let hintData = [
                    { "comID": "COM10000133", "companyname": "中科院上海药物所", 'csalesman': null },
                    { "comID": "COM10002568", "companyname": "协和药物所", 'csalesman': '张亚青' },
                    { "comID": "COM10004293", "companyname": "中国医学科学院药物所", 'csalesman': null },
                ];

              //  DisplayList(hintData);


            }
        }

        function getCompanybyID(e) {
            let node = e.target;
            let comID = node.getAttribute('comID');
            let comName = node.innerHTML;
            let oldsalesman = node.getAttribute('salesman');
            if (oldsalesman != null) {
                // console.log(oldsalesman);
            }
            let url = host + '/comMerge/getContactSalesByCompanyId?comID=' + comID;

            
            fetch(url, {
                    mode: 'no-cors', // 'cors' by default
                    method: 'Get',
                    headers: {
                        'Content-Type': 'text/plain',
                        'Access-Control-Allow-Origin': '*',
                    },
                    // body: JSON.stringify(data),
                }).then(function(response){
                    console.log(response);
                    return response.json();
                }).then(data => {
                    displayOne(data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            



            function displayOne(c) {
                let countText = '';
                c.forEach(function (item, index) {
                    countText = countText + item[0] + '(' + item[1] + ') '
                })

                let companyDsp = document.getElementById('companyDsp');
                companyDsp.innerHTML = comID + " " + comName + "<span>" + countText + "</span>";
                companyDsp.setAttribute('comID', comID);
                companyDsp.setAttribute('oldsalesman', oldsalesman);

                let chooseOne = document.getElementById('chooseOne');
                chooseOne.innerHTML="<option></option>"
                salesmanList.forEach(function (item, index) {
                    let node = document.createElement('option')
                    let t = document.createTextNode(item);
                    if (item == oldsalesman) {
                        node.setAttribute('selected', 'selected');
                    }
                    node.appendChild(t);
                    node.setAttribute("value", item);
                    chooseOne.appendChild(node);
                });
            }

            let count = [["陈娜", 2], ["王月红", 1]];
            //displayOne(count);


        }

        document.getElementById('updateConfirm').addEventListener('click', function (e) {
            e.preventDefault();
            let salesman = document.getElementById('chooseOne').value;
            let comID = document.getElementById('companyDsp').getAttribute('comID');
            let oldsalesman = document.getElementById('companyDsp').getAttribute('oldsalesman');
            if (comID === undefined || comID == null || comID.length < 2 || salesman.length < 2) {
                alert('提交的项目无效')
            } else {
                // console.log(salesman + ' ' + comID);
                let url = host + '/comMerge/updateSales';
                fetch(url, {
                    method: 'POST', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({comID : comID, newSalesName: salesman, oldSalesName: oldsalesman}),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                        if(data.code == 0 ){
                            alert('更新成功')
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });


            }


        })





    </script>

</body>

</html>